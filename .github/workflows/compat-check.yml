name: Core DS Update Check
on:
  repository_dispatch:
    types: [core-ds-update]

jobs:
  check-compatibility:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: adesso-forge/ds-shared
          path: ds-shared
      - uses: actions/checkout@v4
        with:
          repository: adesso-forge/ds-core
          path: ds-core
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://npm.pkg.github.com'
      - name: Build ds-shared
        working-directory: ds-shared
        run: pnpm install --no-frozen-lockfile && pnpm build
      - name: Build ds-core
        working-directory: ds-core
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.pnpm = pkg.pnpm || {};
            pkg.pnpm.overrides = { '@adesso-forge/ds-shared': 'link:../ds-shared' };
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          pnpm install --no-frozen-lockfile
          pnpm build
      - name: Install and build with updated core
        id: build
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.pnpm = pkg.pnpm || {};
            pkg.pnpm.overrides = pkg.pnpm.overrides || {};
            pkg.pnpm.overrides['@adesso-forge/ds-shared'] = 'link:./ds-shared';
            pkg.pnpm.overrides['@adesso-forge/core-ds'] = 'link:./ds-core';
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          pnpm install --no-frozen-lockfile
          pnpm build
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create PR if passing
        if: steps.build.outcome == 'success'
        run: |
          VERSION="${{ github.event.client_payload.version }}"

          # Clean up checked-out repos
          rm -rf ds-shared ds-core

          # Revert pnpm.overrides injection from package.json
          git checkout -- package.json
          git checkout -- pnpm-lock.yaml || true

          # Update compatibility.json with the new tested version
          node -e "
            const fs = require('fs');
            const compat = JSON.parse(fs.readFileSync('compatibility.json', 'utf8'));
            compat.compatibility = compat.compatibility || {};
            compat.compatibility['@adesso-forge/core-ds'] = '^${VERSION}';
            compat.tested = compat.tested || {};
            compat.tested['@adesso-forge/core-ds'] = compat.tested['@adesso-forge/core-ds'] || [];
            if (!compat.tested['@adesso-forge/core-ds'].includes('${VERSION}')) {
              compat.tested['@adesso-forge/core-ds'].push('${VERSION}');
            }
            fs.writeFileSync('compatibility.json', JSON.stringify(compat, null, 2) + '\n');
          "

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b fix/core-ds-$VERSION
          git add compatibility.json
          git commit -m "fix: update core-ds compatibility to $VERSION"
          git push origin fix/core-ds-$VERSION
          gh pr create \
            --title "fix: update core-ds compatibility to $VERSION" \
            --body "## Core DS Update

          **New version:** \`@adesso-forge/core-ds@$VERSION\`

          ### Changes
          - Updated \`compatibility.json\` to track tested version \`$VERSION\`

          ### Verification
          Automated compatibility check **passed** â€” build succeeded against core-ds@$VERSION."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create issue if failing
        if: steps.build.outcome == 'failure'
        run: |
          gh issue create \
            --title "Incompatible with core-ds@${{ github.event.client_payload.version }}" \
            --body "Automated compatibility check failed. Manual intervention required."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
